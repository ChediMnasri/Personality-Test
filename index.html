<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MBTI TEST — Mind Odyssey (Pro)</title>

  <!-- Tailwind CDN: fast dev, production-grade utilities -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // small Tailwind extension
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mbtiPurple: '#7c3aed',
            mbtiBlue: '#2563eb',
            mbtiGreen: '#16a34a',
            mbtiYellow: '#facc15'
          },
          fontFamily: { inter: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    };
  </script>

  <style>
    /* =========================================================================
       PROFESSIONAL SINGLE-FILE MBTI APP
       - Smooth animated background (MBTI colors)
       - Glass-like content area (subtle, not boxed)
       - Accessibility focus outlines and keyboard support
       - Polished transitions
       - Scoring algorithm uses non-linear weighting to favor extremes
       ========================================================================= */

    :root{
      --bg-duration: 28s;
      --accent-a: #2563eb; /* blue */
      --accent-b: #7c3aed; /* purple */
      --accent-c: #16a34a; /* green */
      --accent-d: #facc15; /* yellow */
      --ui-contrast: rgba(255,255,255,0.95);
      --glass-alpha: 0.10;
      --focus-color: rgba(37,99,235,0.14);
    }

    html,body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: var(--ui-contrast);
      background-attachment: fixed;
    }

    /* -------------------------
       Background gradient animation
       ------------------------- */
    body {
      --g1: var(--accent-c);
      --g2: var(--accent-a);
      --g3: var(--accent-b);
      --g4: var(--accent-d);

      background: linear-gradient(90deg,var(--g1),var(--g2),var(--g3),var(--g4),var(--g1));
      background-size: 200% 200%;
      animation: bgShift var(--bg-duration) ease-in-out infinite;
      transition: background 900ms ease;
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 2rem;
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 25% 50%; }
      50% { background-position: 50% 50%; }
      75% { background-position: 75% 50%; }
      100% { background-position: 100% 50%; }
    }
    .bg-paused { animation-play-state: paused !important; }

    /* -------------------------
       Layout shell
       ------------------------- */
    .shell {
      width:100%;
      max-width:1180px;
      display:grid;
      grid-template-columns:1fr;
      grid-template-rows:auto 1fr auto;
      gap:1rem;
      position:relative;
      z-index:2;
      box-sizing:border-box;
    }

    /* subtle ambient overlay to improve legibility slightly */
    .ambient {
      position:absolute; inset:0; border-radius:18px; pointer-events:none;
      background:linear-gradient(180deg, rgba(0,0,0,0.00), rgba(0,0,0,0.00));
      z-index:0;
      transition: background 900ms ease;
    }

    header.app-header {
      z-index: 12;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 0.2rem 0;
    }

    /* logo smaller and less dominating per request */
    .brand {
      display:flex;
      gap:0.8rem;
      align-items:center;
    }
    .logo {
      width:44px; height:44px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      color:white; font-weight:900; font-size:14px;
      background: linear-gradient(135deg,var(--accent-b), var(--accent-a));
      box-shadow: 0 10px 36px rgba(2,6,23,0.12);
    }
    .brand-title {
      font-weight:800;
      font-size:1.05rem;
      letter-spacing:-0.01em;
      margin:0;
      color: rgba(255,255,255,0.95);
    }
    .brand-sub {
      font-size:0.85rem;
      color: rgba(255,255,255,0.86);
      margin-top:2px;
    }

    /* progress badge right */
    .progress-badge {
      padding:0.45rem 0.8rem; border-radius:999px;
      background: rgba(0,0,0,0.18); color:white; font-weight:700;
      box-shadow: 0 8px 30px rgba(2,6,23,0.12);
    }

    /* -------------------------
       Main content: questions area
       - no heavy white card; instead glass-ish surface
       - content visually dominant
       ------------------------- */
    main.app-main {
      z-index: 10;
      display:flex; align-items:flex-start; justify-content:center;
      padding: 6px 0 0 0;
      position:relative;
    }

    .content {
      width:100%; max-width:820px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: clamp(18px, 2.8vw, 28px);
      box-shadow: 0 16px 60px rgba(2,6,23,0.12);
      box-sizing:border-box;
      z-index: 10;
      min-height: 56vh;
      display:flex;
      flex-direction:column;
      gap: 1.1rem;
      transition: transform 200ms ease;
    }

    /* Make question area more visually dominant */
    .q-text { font-weight:900; font-size: clamp(1.1rem, 1.8vw, 1.5rem); color: rgba(255,255,255,0.98); line-height:1.08; text-shadow: 0 8px 30px rgba(0,0,0,0.18); }

    .q-meta { color: rgba(255,255,255,0.88); font-weight:700; font-size:0.95rem; }

    /* -------------------------
       Options: scale 1..10 with labels below for clarity
       - Buttons are sizable, with clear selected state
       ------------------------- */
    .options {
      display:flex; gap:0.6rem; flex-wrap:wrap; justify-content:center; align-items:center;
      margin-top: 8px;
    }
    .option {
      width:56px; height:56px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:1rem;
      color: rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      transition: transform .14s cubic-bezier(.2,.9,.3,1), box-shadow .14s ease, background .14s ease;
      cursor:pointer; user-select:none; outline:none;
    }
    .option:hover { transform: translateY(-6px); box-shadow: 0 12px 40px rgba(0,0,0,0.14); }
    .option:active { transform: translateY(-2px); }

    .option.selected {
      background: linear-gradient(90deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94));
      color: #0b1220; box-shadow: 0 18px 60px rgba(0,0,0,0.2); transform: translateY(-8px) scale(1.07);
      border:none;
    }
    .option:focus { box-shadow: 0 0 0 8px rgba(37,99,235,0.08); }

    /* Answer scale labels (emotional anchors) */
    .scale-legend {
      display:flex; justify-content:space-between; margin-top:6px; color: rgba(255,255,255,0.9); font-size:0.9rem;
    }
    .scale-legend .left, .scale-legend .mid, .scale-legend .right { max-width:30%; text-align:center; }

    /* -------------------------
       Nav row
       ------------------------- */
    .nav { display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-top:10px; }
    .nav-left { color: rgba(255,255,255,0.9); font-weight:700; }
    .nav-right { display:flex; gap:1rem; align-items:center; }

    .btn {
      padding: 10px 16px; border-radius: 12px; font-weight:800; cursor:pointer;
      color: white; border:none; background: linear-gradient(90deg,var(--accent-a), var(--accent-b)); box-shadow: 0 14px 40px rgba(37,99,235,0.16);
      transition: transform 120ms ease, opacity 120ms ease;
    }
    .btn.secondary {
      background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.94); box-shadow: 0 8px 18px rgba(2,6,23,0.06); border: 1px solid rgba(255,255,255,0.06);
    }
    .btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }

    /* -------------------------
       Loader ring
       ------------------------- */
    .loader-ring {
      width:84px; height:84px; border-radius:999px;
      border:8px solid transparent;
      border-top-color: var(--accent-a); border-right-color: var(--accent-c); border-bottom-color: var(--accent-d); border-left-color: var(--accent-b);
      animation: spin 1.1s linear infinite;
      margin-bottom:6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* -------------------------
       Result section styles
       - per-axis gradients
       - axis percentage labels
       ------------------------- */
    .result {
      display:flex; flex-direction:column; align-items:center; gap:1rem; text-align:center;
      padding-top: 6px;
    }
    .result .type { font-size: clamp(2.2rem, 4vw, 4.2rem); font-weight:900; color:white; text-shadow: 0 12px 48px rgba(0,0,0,0.28); }
    .result .desc { max-width:760px; color: rgba(255,255,255,0.95); font-size:1rem; margin-top:6px; }

    .axis-list { width:100%; max-width:760px; display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .axis-row { display:flex; align-items:center; gap:12px; }
    .axis-label { width:32px; font-weight:800; color: rgba(255,255,255,0.95); }
    .axis-bar { flex:1; height:12px; border-radius:999px; background: rgba(255,255,255,0.12); overflow:hidden; }
    .axis-fill { height:100%; width:0%; border-radius:999px; transition: width 700ms cubic-bezier(.2,.9,.3,1); }

    /* per-axis gradient classes defined below via style block insertion from JS if needed */

    /* -------------------------
       Small responsive tweaks
       ------------------------- */
    @media (max-width:720px) {
      .content { padding: 14px; min-height: 60vh; }
      .option { width:50px; height:50px; }
      .logo { width:40px; height:40px; font-size:13px; border-radius:10px; }
      .brand-title { font-size:0.98rem; }
    }

    /* small utility */
    .hidden { display:none !important; }
    .center { display:flex; align-items:center; justify-content:center; }

  </style>
</head>

<body>
  <div class="shell" role="application" aria-labelledby="app-title">
    <div class="ambient" aria-hidden="true"></div>

    <!-- Header -->
    <header class="app-header" role="banner">
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true">MBTI</div>
        <div>
          <div id="app-title" class="brand-title">MBTI TEST</div>
          <div id="app-sub" class="brand-sub">Focused, scientific-feeling personality experience</div>
        </div>
      </div>

      <div id="progressBadge" class="progress-badge" aria-live="polite">Progress <span id="progressText">0 / 8</span></div>
    </header>

    <!-- Main content -->
    <main class="app-main" role="main">
      <section class="content" id="content" aria-live="polite">
        <!-- JS will render questions or results here -->
      </section>
    </main>

    <!-- Footer -->
    <footer class="app-footer" style="z-index:12; text-align:center; padding-top:6px;">
      <small style="color: rgba(255,255,255,0.9);">Crafted for clarity — answer honestly, enjoy the process.</small>
    </footer>
  </div>

  <script>
  /* =========================================================================
     APP JAVASCRIPT
     - Questions, rendering, scoring, result logic, share button
     - Nonlinear weighting for scoring, secondary-type influence
     ========================================================================= */

  /**********************
   * Data
   **********************/
  const QUESTIONS = [
    { id: 'q1', axis: 'EI', direction: 1, text: 'You enjoy being the center of attention at social events.' },
    { id: 'q2', axis: 'EI', direction: -1, text: 'You prefer spending free time in calm, quiet places.' },
    { id: 'q3', axis: 'SN', direction: 1, text: 'You are more interested in facts than abstract ideas.' },
    { id: 'q4', axis: 'SN', direction: -1, text: 'You often think about future possibilities rather than current realities.' },
    { id: 'q5', axis: 'TF', direction: 1, text: 'You prioritize logic over emotions when making decisions.' },
    { id: 'q6', axis: 'TF', direction: -1, text: 'You value empathy and emotional awareness in others.' },
    { id: 'q7', axis: 'JP', direction: 1, text: 'You prefer structure and clear plans.' },
    { id: 'q8', axis: 'JP', direction: -1, text: 'You like to keep your options open and go with the flow.' }
  ];

  const TYPES = ["INTJ","INTP","ENTJ","ENTP","INFJ","INFP","ENFJ","ENFP","ISTJ","ISFJ","ESTJ","ESFJ","ISTP","ISFP","ESTP","ESFP"];

  const GROUP_MAP = {
    INTJ:'analyst', INTP:'analyst', ENTJ:'analyst', ENTP:'analyst',
    INFJ:'diplomat', INFP:'diplomat', ENFJ:'diplomat', ENFP:'diplomat',
    ISTJ:'sentinel', ISFJ:'sentinel', ESTJ:'sentinel', ESFJ:'sentinel',
    ISTP:'explorer', ISFP:'explorer', ESTP:'explorer', ESFP:'explorer'
  };

  const GROUP_COLOR = {
    analyst: '#7c3aed',
    diplomat: '#16a34a',
    sentinel: '#2563eb',
    explorer: '#facc15'
  };

  // Short human-readable descriptions for each type (for summary)
  const TYPE_SUMMARIES = {
    INTJ: "Reserved visionary who designs systems and strategies. You prefer long-term planning and independence.",
    INTP: "Analytical idea generator, curious and theoretical. You enjoy solving conceptual puzzles.",
    ENTJ: "Confident organizer and leader; strategic, decisive, and focused on results.",
    ENTP: "Inventive debater and explorer; loves ideation and novel approaches.",
    INFJ: "Introspective empath with long-range vision and a drive to help.",
    INFP: "Idealistic and values-driven; guided by inner authenticity and creativity.",
    ENFJ: "Charismatic connector who brings people together and inspires shared purpose.",
    ENFP: "Enthusiastic explorer; imaginative, curious, and people-centered.",
    ISTJ: "Dependable organizer; values tradition, thoroughness, and responsibility.",
    ISFJ: "Supportive caretaker; detail oriented, loyal, and attentive to needs.",
    ESTJ: "Practical manager; enforces order, efficiency and clarity.",
    ESFJ: "Warm organizer; socially oriented and focused on harmony and care.",
    ISTP: "Practical, hands-on problem solver who values skill and adaptability.",
    ISFP: "Gentle, sensory-driven artist; values personal authenticity and experiences.",
    ESTP: "Action-oriented doer; energetic, pragmatic, and quick to respond.",
    ESFP: "Playful connector; spontaneous entertainer who enjoys life and people."
  };

  /**********************
   * App State
   **********************/
  const state = {
    index: 0,
    answers: {} // qid -> integer 1..10
  };

  /**********************
   * Helpers (DOM)
   **********************/
  function $id(id){ return document.getElementById(id); }
  function create(tag, attrs={}, children=[]){
    const el = document.createElement(tag);
    for(const k in attrs){
      if(k==='class') el.className = attrs[k];
      else if(k==='text') el.appendChild(document.createTextNode(attrs[k]));
      else el.setAttribute(k, attrs[k]);
    }
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if(c===null||c===undefined) return;
      el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    });
    return el;
  }

  /**********************
   * Scoring: weighted + nonlinear
   *
   * Approach:
   * 1. For each answer (1..10), normalize to center (0 at midpoint 5.5).
   * 2. Apply a nonlinear transfer function that amplifies extremes (sigmoid-like / cubic).
   * 3. Multiply by question direction (to flip axes where appropriate).
   * 4. Aggregate per-axis means.
   * 5. Map axis mean to a "probability" for both letters (E vs I ...).
   * 6. Compute a score for each of 16 types by multiplying probabilities for their four letters.
   * 7. Primary type = highest score; secondary = second highest. Influence = secondaryScore/primaryScore.
   *
   * This makes extremes carry more weight while preserving stability.
   **********************/
  function normalizeToCenter(v){
    // map 1..10 to -1..1 with midpoint 5.5
    return (Number(v) - 5.5) / 4.5;
  }

  // Nonlinear weighting: cubic + scaled logistic blend
  function weightedScore(x){
    // x in [-1,1], amplify extremes using cubic and a soft logistic shape
    // output still in [-1,1] roughly
    const cubic = Math.sign(x) * Math.pow(Math.abs(x), 2.2); // > linear near extremes
    // logistic component to compress midrange lightly
    const logistic = (1 / (1 + Math.exp(-4 * x))) - 0.5; // roughly in (-0.5,0.5)
    // blend
    const blended = (cubic * 0.78) + (logistic * 0.44);
    // normalize approximate range
    return Math.max(-1, Math.min(1, blended));
  }

  function computeMBTIAdvanced(answers){
    // per-axis arrays
    const axes = { EI: [], SN: [], TF: [], JP: [] };
    for(const q of QUESTIONS){
      const v = answers[q.id];
      if(v === undefined) continue;
      const n = normalizeToCenter(v) * q.direction; // direction flips sign where needed
      const w = weightedScore(n); // nonlinear weight
      axes[q.axis].push(w);
    }

    // axis means
    const avg = {};
    for(const a in axes){
      const arr = axes[a];
      const mean = arr.length ? (arr.reduce((s,x)=>s+x,0) / arr.length) : 0;
      avg[a] = mean; // -1 to 1
    }

    // convert axis mean to letter probabilities
    // mean ~ 1 => letter A (E,S,T,J) strong; mean ~ -1 => opposite
    // convert via logistic mapping to [0,1]
    function meanToProb(mean){
      // map mean (-1..1) -> probability for the positive letter
      // use smooth logistic centered at 0
      const p = 1 / (1 + Math.exp(-4 * mean));
      return p;
    }

    const probs = {
      E: meanToProb(avg.EI),
      I: 1 - meanToProb(avg.EI),
      S: meanToProb(avg.SN),
      N: 1 - meanToProb(avg.SN),
      T: meanToProb(avg.TF),
      F: 1 - meanToProb(avg.TF),
      J: meanToProb(avg.JP),
      P: 1 - meanToProb(avg.JP)
    };

    // score each of the 16 types by multiplying their letter probabilities
    // small smoothing (epsilon) to avoid exact zeros
    const eps = 1e-6;
    const typeScores = {};
    for(const t of TYPES){
      const letters = t.split('');
      const sc = ( (probs[letters[0]] || eps) * (probs[letters[1]] || eps) * (probs[letters[2]] || eps) * (probs[letters[3]] || eps) );
      typeScores[t] = sc;
    }

    // sort types by score descending
    const sorted = Object.entries(typeScores).sort((a,b)=>b[1]-a[1]);

    const primary = sorted[0][0];
    const secondary = sorted[1][0];
    const primaryScore = sorted[0][1];
    const secondaryScore = sorted[1][1];

    // compute axis percentage strings for UI
    const axisPercent = {};
    axisPercent.EI = Math.round(meanToProb(avg.EI) * 100); // percent E
    axisPercent.SN = Math.round(meanToProb(avg.SN) * 100); // percent S
    axisPercent.TF = Math.round(meanToProb(avg.TF) * 100); // percent T
    axisPercent.JP = Math.round(meanToProb(avg.JP) * 100); // percent J

    return {
      avg, probs, typeScores, sorted, primary, secondary,
      primaryScore, secondaryScore, axisPercent
    };
  }

  /**********************
   * Rendering code
   **********************/
  const container = document.getElementById('content');

  function renderQuestion(){
    container.innerHTML = '';

    const q = QUESTIONS[state.index];

    // header row
    const header = create('div', { class: 'q-head flex items-center justify-between' }, [
      create('div', { class: 'q-meta' }, `Question ${state.index+1} of ${QUESTIONS.length}`),
      create('div', { class: 'q-sub' }, 'Pick how much the statement fits you (1 — disagree, 10 — agree)')
    ]);

    const qtext = create('div', { class: 'q-text mt-1' }, q.text);

    // options
    const options = create('div', { class: 'options mt-3', role: 'radiogroup', 'aria-label': q.text });
    for(let i=1;i<=10;i++){
      const btn = create('button', { class: 'option', 'data-val': i, type: 'button' }, String(i));
      if(state.answers[q.id] === i) btn.classList.add('selected');
      btn.addEventListener('click', ()=> {
        state.answers[q.id] = i;
        updateProgress();
        updateSelectionVisuals();
      });
      btn.addEventListener('keydown', (e)=> {
        if(/^[0-9]$/.test(e.key)){
          e.preventDefault();
          const val = (e.key === '0') ? 10 : Number(e.key);
          state.answers[q.id] = val;
          updateProgress();
          updateSelectionVisuals();
        }
      });
      options.appendChild(btn);
    }

    // scale legend anchors
    const legend = create('div', { class: 'scale-legend mt-2' }, [
      create('div', { class: 'left' }, '1 — Strongly disagree'),
      create('div', { class: 'mid' }, '5 — Neutral / Unsure'),
      create('div', { class: 'right' }, '10 — Strongly agree')
    ]);

    // nav row
    const nav = create('div', { class: 'nav mt-4' });
    const left = create('div', { class: 'nav-left' }, 'Tip: use number keys or click');
    const right = create('div', { class: 'nav-right' });

    const prevBtn = create('button', { class: 'btn secondary', id: 'prevBtn', type: 'button' }, '← Previous');
    prevBtn.disabled = (state.index === 0);
    prevBtn.addEventListener('click', ()=> {
      if(state.index > 0) { state.index--; animateQuestionChange(renderQuestion); }
    });

    const nextLabel = (state.index === QUESTIONS.length -1) ? 'Show Results' : 'Next →';
    const nextBtn = create('button', { class: 'btn', id: 'nextBtn', type: 'button' }, nextLabel);
    nextBtn.addEventListener('click', ()=> {
      if(!state.answers[q.id]) { showTemporaryMessage('Please choose an answer to continue.'); return; }
      if(state.index < QUESTIONS.length - 1){ state.index++; animateQuestionChange(renderQuestion); }
      else { showLoaderThenResults(); }
    });

    right.appendChild(prevBtn);
    right.appendChild(nextBtn);

    nav.appendChild(left);
    nav.appendChild(right);

    container.appendChild(header);
    container.appendChild(qtext);
    container.appendChild(options);
    container.appendChild(legend);
    container.appendChild(nav);

    // UI updates
    updateProgress();
    updateSelectionVisuals();
    focusSelectedOption();
  }

  function updateSelectionVisuals(){
    const q = QUESTIONS[state.index];
    document.querySelectorAll('.options .option').forEach(btn=>{
      const val = Number(btn.getAttribute('data-val'));
      if(state.answers[q.id] === val){
        btn.classList.add('selected');
        btn.setAttribute('aria-pressed','true');
      } else {
        btn.classList.remove('selected');
        btn.setAttribute('aria-pressed','false');
      }
    });
  }

  function focusSelectedOption(){
    const q = QUESTIONS[state.index];
    const sel = document.querySelector(`.options .option[data-val="${state.answers[q.id] ?? 1}"]`);
    (sel || document.querySelector('.options .option'))?.focus();
  }

  function updateProgress(){
    const count = Object.keys(state.answers).length;
    $id('progressText').textContent = `${count} / ${QUESTIONS.length}`;
  }

  // small temporary message
  let tempTimer = null;
  function showTemporaryMessage(msg, ms=1500){
    const note = create('div', { class: 'progress-badge', role: 'status', 'aria-live': 'polite' }, msg);
    note.style.position = 'absolute';
    note.style.left = '50%';
    note.style.top = '10px';
    note.style.transform = 'translateX(-50%)';
    note.style.zIndex = 60;
    document.body.appendChild(note);
    if(tempTimer) clearTimeout(tempTimer);
    tempTimer = setTimeout(()=>note.remove(), ms);
  }

  // transition between questions
  function animateQuestionChange(nextFn){
    const el = container;
    el.style.transition = 'opacity 180ms ease, transform 200ms ease';
    el.style.opacity = '0';
    el.style.transform = 'translateY(6px)';
    setTimeout(()=>{
      nextFn();
      el.style.opacity = '0';
      el.style.transform = 'translateY(-6px)';
      requestAnimationFrame(()=>{
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      });
    }, 170);
  }

  /**********************
   * Loader + result flow
   **********************/
  function showLoaderThenResults(){
    container.innerHTML = '';
    const wrap = create('div', { class: 'center flex-col' });
    wrap.style.padding = '28px 0';
    const ring = create('div', { class: 'loader-ring' });
    const text = create('div', { class: 'q-text mt-4' }, 'Analyzing your personality matrix...');
    wrap.appendChild(ring);
    wrap.appendChild(text);
    container.appendChild(wrap);

    // pause background to make loader feel stable
    document.body.classList.add('bg-paused');

    setTimeout(()=>{
      const res = computeMBTIAdvanced(state.answers);
      renderResult(res);
    }, 3000);
  }

  // render result with axis bars, secondary influence and summary
  function renderResult(res){
    container.innerHTML = '';
    // freeze background to group color
    const primary = res.primary;
    const group = GROUP_MAP[primary] || 'analyst';
    const color = GROUP_COLOR[group] || '#7c3aed';
    document.body.style.transition = 'background 900ms ease';
    document.body.style.background = color;
    document.body.classList.remove('bg-paused');

    // show result card
    const wrap = create('div', { class: 'result' });
    wrap.appendChild(create('div', { class: 'type' }, res.primary));

    // axis percentage with gradients
    const axisList = create('div', { class: 'axis-list' });
    // per-axis color gradients mapping
    const axisGradients = {
      EI: `linear-gradient(90deg, ${shade('#7c3aed', -8)}, ${shade('#2563eb', 6)})`, // purple -> blue
      SN: `linear-gradient(90deg, ${shade('#16a34a', 6)}, ${shade('#facc15', -6)})`, // green -> yellow
      TF: `linear-gradient(90deg, ${shade('#2563eb', 6)}, ${shade('#16a34a', -6)})`, // blue -> green
      JP: `linear-gradient(90deg, ${shade('#7c3aed', 4)}, ${shade('#facc15', -4)})`  // purple -> yellow
    };

    // render axis rows
    ['EI','SN','TF','JP'].forEach(axis => {
      const percent = res.axisPercent[axis]; // percent E (or S or T or J)
      const row = create('div', { class: 'axis-row' });
      row.appendChild(create('div', { class: 'axis-label' }, axis[0]));
      const bar = create('div', { class: 'axis-bar' });
      const fill = create('div', { class: 'axis-fill' });
      fill.style.background = axisGradients[axis] || 'linear-gradient(90deg,#fff,#eee)';
      fill.style.width = '0%';
      // target width depends: if axis is EI, percent indicates E strength; we show percent for the letter in mapping
      fill.dataset.target = `${percent}%`;
      bar.appendChild(fill);
      row.appendChild(bar);
      row.appendChild(create('div', { class: 'axis-label', style:'text-align:right' }, axis[1]));
      axisList.appendChild(row);
      // animate later
    });

    wrap.appendChild(axisList);

    // summary text based on primary type
    const summary = TYPE_SUMMARIES[res.primary] || "A distinctive personality — your results reflect a unique blend.";
    wrap.appendChild(create('div', { class: 'desc' }, summary));

    // compute secondary influence
    const primaryScore = res.primaryScore;
    const secondary = res.secondary;
    const secondaryScore = res.secondaryScore;
    const influencePct = Math.round((secondaryScore / primaryScore) * 100);

    const influenceText = `${res.primary} with ${influencePct}% ${secondary} influence`;
    wrap.appendChild(create('div', { class: 'q-sub' }, influenceText));

    // share + restart buttons
    const actions = create('div', { class: 'nav mt-4' });
    const shareBtn = create('button', { class: 'btn' }, 'Share result');
    shareBtn.addEventListener('click', ()=> {
      const shareText = `I got ${res.primary} on this MBTI test (${influencePct}% ${secondary} influence). See yours!`;
      copyToClipboard(shareText);
      showTemporaryMessage('Result copied to clipboard!');
    });

    const restart = create('button', { class: 'btn secondary' }, 'Restart');
    restart.addEventListener('click', ()=> {
      // reset state and restore animated bg
      state.index = 0; state.answers = {}; document.body.style.background = '';
      renderQuestion();
    });

    actions.appendChild(shareBtn);
    actions.appendChild(restart);

    wrap.appendChild(actions);

    // append to container
    container.appendChild(wrap);

    // animate axis fills after insertion
    setTimeout(()=>{
      document.querySelectorAll('.axis-fill').forEach(el=>{
        el.style.width = el.dataset.target || '50%';
      });
    }, 80);
  }

  /**********************
   * Secondary utilities
   **********************/
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).catch(()=> fallbackCopy(text));
    } else fallbackCopy(text);
  }
  function fallbackCopy(text){
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch(e){}
    ta.remove();
  }

  // small color helper to slightly shade a hex color
  function shade(hex, percent){
    // percent -100..100
    const h = hex.replace('#','');
    const num = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h, 16);
    let r = (num >> 16) + percent;
    let g = ((num >> 8) & 0x00FF) + percent;
    let b = (num & 0x0000FF) + percent;
    r = Math.max(0, Math.min(255, r)); g = Math.max(0, Math.min(255, g)); b = Math.max(0, Math.min(255, b));
    return `rgb(${r},${g},${b})`;
  }

  /**********************
   * Keyboard nav (global)
   **********************/
  window.addEventListener('keydown', (e)=>{
    const active = document.activeElement;
    if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;

    if(/^[0-9]$/.test(e.key)){
      const val = (e.key === '0') ? 10 : Number(e.key);
      const q = QUESTIONS[state.index];
      state.answers[q.id] = val;
      updateProgress();
      updateSelectionVisuals();
      focusSelectedOptionIfAvailable();
    }
    if(e.key === 'ArrowRight'){
      const next = document.querySelector('#nextBtn');
      if(next) next.click();
    }
    if(e.key === 'ArrowLeft'){
      const prev = document.querySelector('#prevBtn');
      if(prev) prev.click();
    }
  });

  function focusSelectedOptionIfAvailable(){
    const q = QUESTIONS[state.index];
    const el = document.querySelector(`.options .option[data-val="${state.answers[q.id] ?? 1}"]`);
    if(el) el.focus();
  }

  /**********************
   * Boot
   **********************/
  function boot(){
    updateProgress();
    renderQuestion();
  }

  // update progress text
  function updateProgress(){ const cnt = Object.keys(state.answers).length; $id('progressText').textContent = `${cnt} / ${QUESTIONS.length}`; }

  document.addEventListener('DOMContentLoaded', boot);

  </script>
</body>
</html>
